name: Build and Publish Debian Package

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-deb:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            fakeroot \
            devscripts \
            debhelper \
            dh-python \
            pybuild-plugin-pyproject \
            python3-all \
            python3-setuptools \
            python3-pip \
            python3-wheel \
            python3-build \
            python3-installer \
            python3-scapy \
            python3-psutil \
            python3-yaml \
            gpg

      - name: Build Debian package
        run: |
          dpkg-buildpackage -us -uc -b
          mkdir -p dist
          mv ../fluxgen_*.deb dist/
          mv ../fluxgen_*.buildinfo dist/ 2>/dev/null || true
          mv ../fluxgen_*.changes dist/ 2>/dev/null || true

      - name: Upload deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: debian-package
          path: dist/*.deb

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: dist/*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-apt-repo:
    needs: build-deb
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download deb artifact
        uses: actions/download-artifact@v4
        with:
          name: debian-package
          path: dist/

      - name: Setup GPG key
        run: |
          # Generate a GPG key for signing (or use secrets for persistent key)
          cat > gpg-batch <<EOF
          %echo Generating GPG key
          Key-Type: RSA
          Key-Length: 4096
          Subkey-Type: RSA
          Subkey-Length: 4096
          Name-Real: Fluxgen APT Repository
          Name-Email: kanchankjha@gmail.com
          Expire-Date: 0
          %no-protection
          %commit
          %echo done
          EOF
          gpg --batch --generate-key gpg-batch
          rm gpg-batch

      - name: Create APT repository structure
        run: |
          mkdir -p apt-repo/pool/main
          mkdir -p apt-repo/dists/stable/main/binary-amd64
          mkdir -p apt-repo/dists/stable/main/binary-i386
          mkdir -p apt-repo/dists/stable/main/binary-all

          # Copy deb files to pool
          cp dist/*.deb apt-repo/pool/main/

          # Generate Packages files
          cd apt-repo

          dpkg-scanpackages --arch all pool/ > dists/stable/main/binary-all/Packages
          dpkg-scanpackages --arch amd64 pool/ > dists/stable/main/binary-amd64/Packages

          gzip -k dists/stable/main/binary-all/Packages
          gzip -k dists/stable/main/binary-amd64/Packages

          # Create Release file
          cat > dists/stable/Release <<EOF
          Origin: Fluxgen
          Label: Fluxgen APT Repository
          Suite: stable
          Codename: stable
          Architectures: amd64 i386 all
          Components: main
          Description: Fluxgen - Multi-client traffic generator
          EOF

          # Add checksums to Release
          {
            echo "MD5Sum:"
            find dists/stable/main -type f -name "Packages*" -exec sh -c 'echo " $(md5sum {} | cut -d" " -f1) $(stat -c%s {}) {}"' \;
            echo "SHA256:"
            find dists/stable/main -type f -name "Packages*" -exec sh -c 'echo " $(sha256sum {} | cut -d" " -f1) $(stat -c%s {}) {}"' \;
          } >> dists/stable/Release

          # Sign the Release file
          gpg --armor --detach-sign -o dists/stable/Release.gpg dists/stable/Release
          gpg --armor --clearsign -o dists/stable/InRelease dists/stable/Release

          # Export public key
          gpg --armor --export > fluxgen.gpg.key

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./apt-repo
          publish_branch: apt-repo
          force_orphan: true
