name: Build, Test, and Publish Packages

on:
  push:
    branches:
      - main
    tags:
      - "v*"
  pull_request:
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run tests
        run: pytest tests/ -q

  build-python:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Build wheel and sdist
        run: |
          python -m pip install --upgrade pip build
          python -m build

      - name: Upload Python artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-artifacts
          path: dist/*

  build-deb:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Debian build deps
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            fakeroot \
            devscripts \
            debhelper \
            dh-python \
            pybuild-plugin-pyproject \
            python3-all \
            python3-setuptools \
            python3-pip \
            python3-wheel \
            python3-build \
            python3-installer \
            python3-scapy \
            python3-psutil \
            python3-yaml

      - name: Build Debian package
        run: |
          dpkg-buildpackage -us -uc -b
          mkdir -p dist
          mv ../fluxgen_*.deb dist/
          mv ../fluxgen_*.buildinfo dist/ 2>/dev/null || true
          mv ../fluxgen_*.changes dist/ 2>/dev/null || true

      - name: Upload Debian artifacts
        uses: actions/upload-artifact@v4
        with:
          name: debian-artifacts
          path: dist/*

  build-rpm:
    needs: test
    runs-on: ubuntu-latest
    container:
      image: fedora:41
    steps:
      - name: Install RPM build deps
        run: |
          dnf -y install \
            git \
            rpm-build \
            rpmdevtools \
            python3-devel \
            pyproject-rpm-macros \
            python3-psutil \
            python3-pyyaml \
            python3-scapy \
            python3-pip \
            python3-setuptools \
            python3-wheel \
            tar \
            gzip

      - name: Checkout
        uses: actions/checkout@v4

      - name: Build source tarball
        run: |
          git config --global --add safe.directory "${GITHUB_WORKSPACE}"
          VERSION=$(python3 - <<'PY'
          import tomllib
          with open("pyproject.toml", "rb") as f:
              print(tomllib.load(f)["project"]["version"])
          PY
          )
          mkdir -p ~/rpmbuild/{SOURCES,SPECS,BUILD,BUILDROOT,RPMS,SRPMS}
          git archive --format=tar.gz --prefix=fluxgen-${VERSION}/ -o ~/rpmbuild/SOURCES/fluxgen-${VERSION}.tar.gz HEAD
          cp packaging/rpm/fluxgen.spec ~/rpmbuild/SPECS/fluxgen.spec
          sed -i "s/^Version:.*/Version:        ${VERSION}/" ~/rpmbuild/SPECS/fluxgen.spec

      - name: Build RPM
        run: |
          rpmbuild -ba ~/rpmbuild/SPECS/fluxgen.spec
          mkdir -p dist
          cp ~/rpmbuild/RPMS/noarch/*.rpm dist/
          cp ~/rpmbuild/SRPMS/*.src.rpm dist/

      - name: Upload RPM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rpm-artifacts
          path: dist/*

  publish-apt-repo:
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    needs: build-deb
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Debian artifacts
        uses: actions/download-artifact@v4
        with:
          name: debian-artifacts
          path: dist/

      - name: Install APT repo tools
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev gnupg

      - name: Import or generate GPG key
        run: |
          if [ -n "${{ secrets.APT_GPG_PRIVATE_KEY }}" ]; then
            echo "${{ secrets.APT_GPG_PRIVATE_KEY }}" | gpg --batch --import
          else
            cat > gpg-batch <<EOF
          %echo Generating Fluxgen APT signing key
          Key-Type: RSA
          Key-Length: 4096
          Subkey-Type: RSA
          Subkey-Length: 4096
          Name-Real: Fluxgen APT Repository
          Name-Email: kanchankjha@gmail.com
          Expire-Date: 0
          %no-protection
          %commit
          %echo done
          EOF
            gpg --batch --generate-key gpg-batch
            rm -f gpg-batch
          fi

      - name: Build and sign APT repo
        run: |
          ./scripts/packaging/build_apt_repo.sh apt-repo stable main
          KEY_ID=$(gpg --list-secret-keys --keyid-format LONG | awk '/sec/{print $2}' | awk -F/ '{print $2}' | head -n1)
          gpg --batch --yes --default-key "${KEY_ID}" --armor --detach-sign -o apt-repo/dists/stable/Release.gpg apt-repo/dists/stable/Release
          gpg --batch --yes --default-key "${KEY_ID}" --clearsign -o apt-repo/dists/stable/InRelease apt-repo/dists/stable/Release
          gpg --armor --export "${KEY_ID}" > apt-repo/fluxgen.gpg.key

      - name: Publish APT repo branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./apt-repo
          publish_branch: apt-repo
          force_orphan: true

  publish-yum-repo:
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    needs: build-rpm
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download RPM artifacts
        uses: actions/download-artifact@v4
        with:
          name: rpm-artifacts
          path: dist/

      - name: Install YUM repo tools
        run: |
          sudo apt-get update
          sudo apt-get install -y createrepo-c

      - name: Build YUM repo metadata
        run: ./scripts/packaging/build_yum_repo.sh yum-repo

      - name: Publish YUM repo branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./yum-repo
          publish_branch: yum-repo
          force_orphan: true

  release-assets:
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    needs: [build-python, build-deb, build-rpm]
    runs-on: ubuntu-latest
    steps:
      - name: Download Python artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-artifacts
          path: dist/python

      - name: Download Debian artifacts
        uses: actions/download-artifact@v4
        with:
          name: debian-artifacts
          path: dist/deb

      - name: Download RPM artifacts
        uses: actions/download-artifact@v4
        with:
          name: rpm-artifacts
          path: dist/rpm

      - name: Publish GitHub release assets
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dist/python/*
            dist/deb/*
            dist/rpm/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-pypi:
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
    needs: build-python
    runs-on: ubuntu-latest
    environment:
      name: pypi
      url: https://pypi.org/p/meraki-fluxgen
    permissions:
      id-token: write
    steps:
      - name: Download Python artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-artifacts
          path: dist/

      - name: Publish to PyPI (trusted publishing)
        uses: pypa/gh-action-pypi-publish@release/v1
